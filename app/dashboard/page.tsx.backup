/**
 * SaaS Dashboard - Starter Template
 *
 * This dashboard is designed as a reusable starting point for SaaS applications.
 * It provides common patterns like user management, organizations, billing, and metrics.
 *
 * CUSTOMIZATION GUIDE:
 * 1. Update DASHBOARD_CONFIG with your app's branding and features
 * 2. Replace sample metrics with real data from your app
 * 3. Customize card content and layouts as needed
 * 4. Add/remove cards using the enabledCards config
 * 5. Modify trial banners and upgrade flows for your pricing
 *
 * KEY COMPONENTS TO CUSTOMIZE:
 * - DASHBOARD_CONFIG: App branding, features, metrics
 * - Trial banner messages: Adapt to your pricing strategy
 * - Card layouts: Modify or replace with app-specific content
 * - Modal content: Update upgrade and creation flows
 */

"use client";

import { useSession } from "@/lib/auth-client";
import { useState, Suspense, useEffect, useRef } from "react";
import { Card, CardContent } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Skeleton } from "@/components/ui/skeleton";

// Icons are now imported in individual card components
import { useRouter, useSearchParams } from "next/navigation";
import { toast } from "sonner";

import { useSubscription } from "@/hooks/use-subscription";
import { useFeatureGate } from "@/hooks/use-feature-gate";
import { useUserOrganizations } from "@/hooks/use-organization-crud";
import { Badge } from "@/components/ui/badge";

// Import modal components
import { CreateOrganizationModal } from "./_components/create-organization-modal";
import { UpgradeModal as MainUpgradeModal } from "./_components/upgrade-modal";
import { UpgradeModal } from "@/components/ui/upgrade-modal";

// Import dashboard card components
import { WelcomeCard } from "./_components/welcome-card";
import { QuickActionsCard } from "./_components/quick-actions-card";
import { TeamActivityCard } from "./_components/team-activity-card";
import { ProjectStatusCard } from "./_components/project-status-card";
import { SystemHealthCard } from "./_components/system-health-card";
import { KeyMetricsCard } from "./_components/key-metrics-card";
import { OrganizationCard } from "./_components/organization-card";
import { UsageMetricsCard } from "./_components/usage-metrics-card";

// App configuration - can be moved to APP_CONFIG if needed

// TODO: Replace these with real data fetching functions
const getSampleMetrics = () => ({
  projectsCount: 12, // TODO: Connect to your app's project count
  featuresCount: 47, // TODO: Connect to your app's feature usage
  membersCount: 3, // TODO: Connect to your app's member count
});

function DashboardContent() {
  const { data: session } = useSession();
  const { isLoading: subscriptionLoading } = useSubscription();
  const {
    showUpgradeModal: showFeatureUpgradeModal,
    setShowUpgradeModal: setShowFeatureUpgradeModal,
    isPro,
  } = useFeatureGate();
  const { data: organizations, isLoading: orgsLoading, refetch } =
    useUserOrganizations();
  const [showUpgradeModal, setShowUpgradeModal] = useState(false);
  const [showCreateOrgModal, setShowCreateOrgModal] = useState(false);
  const router = useRouter();
  const searchParams = useSearchParams();
  const hasShownSuccessToastRef = useRef(false);

  const handleOrganizationCreated = () => {
    // Refresh organizations list
    refetch();
  };

  // Temporary simplified modal usage
  const modals = null;
  };

  if (subscriptionLoading) {
    return (
      <div className="space-y-6">
        {/* Trial Banner Skeleton */}
        <Skeleton className="h-16 w-full rounded-lg" />

        {/* Cards Grid Skeleton */}
        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
          <Skeleton className="h-32 w-full" />
          <Skeleton className="h-32 w-full" />
          <Skeleton className="h-32 w-full" />
        </div>
      </div>
    );
  }

  return (
    <div className="space-y-6">
      {/* TODO: Customize header for your app */}
      <div>
        <h1 className="text-3xl font-bold">Dashboard</h1>
        <p className="text-muted-foreground">
          Welcome back, {session?.user?.name || "User"}!
        </p>
      </div>

      {/* Upgrade banner for free users */}
      {!isPro && (
        <Card>
          <CardContent>
            <div className="flex items-center justify-between">
              <div>
                <h3 className="text-lg font-semibold flex">
                  <span>Upgrade to</span>
                  <Badge variant="default" className="rounded-sm ml-2 text-sm">
                    Pro
                  </Badge>
                </h3>
                <p className="text-sm  mt-1">
                  Unlock unlimited features and premium tools
                </p>
              </div>
              <Button variant="default" onClick={handleUpgrade}>
                Upgrade Now
              </Button>
            </div>
          </CardContent>
        </Card>
      )}

      {/* Main Content Grid - All cards in responsive grid */}
      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        {/* Organization Management Card */}
        <OrganizationCard
          organizations={organizations}
          isLoading={orgsLoading}
        />

        {/* Welcome Card - First Time User Experience */}
        <WelcomeCard />

        {/* Quick Actions Card */}
        <QuickActionsCard />

        {/* Team Activity Card */}
        <TeamActivityCard />

        {/* Project Status Card */}
        <ProjectStatusCard />

        {/* System Health Card */}
        <SystemHealthCard />

        {/* Key Metrics Card */}
        <KeyMetricsCard />

        {/* Usage Metrics Card */}
        <UsageMetricsCard
          metrics={metrics}
          isPro={isPro}
          triggerUpgrade={() => {
            // This will be handled by the modal itself
          }}
        />
      </div>

      {/* Modals - Simplified for now */}
      {/* TODO: Add modal components back after fixing structure */}
    </div>
  );
}

export default function Dashboard() {
  return (
    <Suspense fallback={<div>Loading...</div>}>
      <DashboardContent />
    </Suspense>
  );
}
